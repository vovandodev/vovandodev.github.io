<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Clouds, Virtualization and something more..."><meta name=Author content="Volodymyr Vrublevskyy"><meta name=keywords content="IT Talks"><link rel=stylesheet href=https://vovando.dev/css/syntax.css><link rel=stylesheet href=https://vovando.dev/css/style.css><script src=https://kit.fontawesome.com/1b7478c139.js crossorigin=anonymous></script><title>IT Talks</title></head><body><aside id=sidenav><header><a href=https://vovando.dev/><img src=https://vovando.dev/avatar.png alt=avatar></a>
<a id=branding href=https://vovando.dev/>IT Talks</a></header><nav><a href=/><i class="fas fa-home fa-sm"></i><span>whoami</span></a>
<a href=/posts><i class="fas fa-keyboard fa-ms"></i><span>blog</span></a>
<a href=/tags><i class="fas fa-tags fa-ms"></i><span>tags</span></a>
<a href=https://github.com/vovandodev target=_blank><i class="fab fa-github fa-ms"></i><span>github</span></a>
<a href=/index.xml><i class="fas fa-rss fa-ms"></i><span>RSS</span></a>
<a href=/contact><i class="far fa-envelope"></i><span>contact</span></a></nav></aside><main id=main><a href=javascript:void(0) id=closebtn onclick=navToggle()><i class="fas fa-bars fa-lg"></i></a><div class=content><h1 id=title>Encrypted Postgres Backups</h1><nav id=TableOfContents></nav><p>The public key should reside on the server that pg_dump is to run on, and the private key should be copied to some “safe place”.</p><p>The next step is to perform the export and encrypt the resulting export file. For good measure, we will also compress the export file using <strong>gzip.</strong></p><p><strong>/usr/bin/pg_dump production -U postgres -h 127.0.0.1 | gzip | openssl smime -encrypt -aes256 -binary -outform DEM -out prod_`date +%Y%m%d%H%M`.gz.enc backup_key.pem.pub</strong></p><p>After running this command, you will be left with an encrypted, compressed database dump called **prod_**_DATE_**.gz.enc**</p><p> </p><p>To decrypt the database dump, copy it to the server where your private key is situated. Then run one of the following commands:</p><p><strong>openssl</strong> ****<strong>smime</strong> **-decrypt -in prod_**_DATE_**.gz.enc -binary -inform DEM –****inkey** **backup_key.****pem** **-out production.gz**</p><p> </p><p>Thats it.</p><p>P.S. I have automated the encryption process via the following shell script that can be run via a cron job. It’s a simple shell script that takes the database name as the first argument, dumps, compresses, and encrypts the database. It also only retains the most recent 7 days of backups: </p><p> </p><p>_#!/bin/bash<br># #######################<br># Postgresql database backup script.<br># – this runs out of the postgres user&rsquo;s crontab<br># – this runs once per day<br># – this takes a database name as the first argument<br># – this compresses the dump with bzip2 compression<br># – this encrypts the dump with aes 256 and  <br>#  <br># To extract:<br># You need the private key associated with the<br># public key defined by the backup_public_key variable.</p><h1 id=heading></h1><p>#   openssl smime -decrypt -in my_database.sql.sql.bz2.enc -binary -inform DEM -inkey private.pem | bzcat >  my_database.sql.sql</p><h1 id=heading-1></h1><p># #######################<br># Database Name<br>database_name="$1"<br>backup_public_key="/opt/db_backups/backup_key.pem.pub"<br># Location to place backups.<br>backup_dir="/opt/db_backups/pg_dump"<br># Numbers of days you want to keep copies of your databases<br>number_of_days=7<br>if [ -z ${database_name} ]<br>then<br> echo &ldquo;Please specify a database name as the first argument&rdquo;<br> exit 1<br>fi<br># String to append to the name of the backup files<br>backup_date=`date +%Y%m%d%H%M`_</p><p><em>echo &ldquo;Dumping ${database_name} to ${backup_dir}${database_name}_${backup_date}.gz.enc&rdquo;</em></p><p><em>pg_dump ${database_name} -U postgres -h 127.0.0.1 | gzip | openssl smime -encrypt -aes256 -binary -outform DEM \<br>-out ${backup_dir}/${database_name}_${backup_date}.gz.enc ${backup_public_key}</em></p><p><em>find ${backup_dir} -type f -prune -mtime \<br>    +${number_of_days} -exec rm -f {} ;</em></p><p> </p><p><strong>Stay tuned!</strong></p><div class=nav-next-prev><div class=nav-prev><a href=https://vovando.dev/2017/04/07/jenkins-xcode-error-select-a-development-team/><i class="fas fa-chevron-left"></i></a></div><a class=nav-top href=#>top</i></a><div class=nav-next><a href=https://vovando.dev/2017/04/13/jenkins-xcode-resource-rules-has-been-deprecated-in-mac-os-x-10-10/><i class="fas fa-chevron-right"></i></a></div></div></div><footer><div class=footer-content><div class=contact-info><div class=footer-mail><i class="far fa-envelope"></i><a href=mailto:hello@vovando.dev>hello@vovando.dev</a></div><div class=footer-phone><i class="fas fa-phone"></i>7777</div></div><p class="copyright meta">Copyright © 2013–2020, all rights reserved.</p></div></footer></main></body><script src=https://vovando.dev/js/navbutton.js></script></html>